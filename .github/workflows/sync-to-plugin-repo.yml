name: Sync skills to Cursor plugin repo

on:
  push:
    branches: [main]
    paths:
      - '**/SKILL.md'
      - 'agile-v-core/**'
      - 'build-agent/**'
      - 'compliance-auditor/**'
      - 'documentation-agent/**'
      - 'logic-gatekeeper/**'
      - 'red-team-verifier/**'
      - 'requirement-architect/**'
      - 'schematic-generator/**'
      - 'test-designer/**'
      - 'domains/**'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout skills repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone plugin repo
        env:
          PLUGIN_REPO_TOKEN: ${{ secrets.PLUGIN_REPO_TOKEN }}
        run: |
          git clone "https://x-access-token:${PLUGIN_REPO_TOKEN}@github.com/Agile-V/agile_v_cursor_plugin.git" plugin-repo
          cd plugin-repo

      - name: Ensure plugin structure
        working-directory: plugin-repo
        run: |
          mkdir -p .cursor-plugin skills
          cat > .cursor-plugin/plugin.json << 'EOF'
          {
            "name": "agile-v-skills",
            "description": "Agent skills for traceable product development: requirements, build, verification, and compliance following the Agile V™ workflow.",
            "author": { "name": "Agile V™" },
            "keywords": ["agile v", "v model", "product development"]
          }
          EOF

      - name: Copy root-level skills into skills/
        working-directory: plugin-repo
        run: |
          for dir in ../*; do
            if [ -d "$dir" ]; then
              name="$(basename "$dir")"
              case "$name" in
                .*) ;;
                domains) ;;
                plugin-repo) ;;
                *)
                  rm -rf "skills/$name"
                  cp -r "$dir" "skills/$name"
                  ;;
              esac
            fi
          done

      - name: Copy domain skills into skills/
        working-directory: plugin-repo
        run: |
          find ../domains -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | while read -r name; do
            rm -rf "skills/$name"
            cp -r "../domains/$name" "skills/$name"
          done

      - name: Commit and push to plugin repo
        working-directory: plugin-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || (git commit -m "Sync skills from agile_v_skills@${{ github.sha }}" && git push)